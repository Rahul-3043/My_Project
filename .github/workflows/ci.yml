name: CI/CD - Build and Deploy Python App to EC2

on:
  workflow_dispatch:   # Manual trigger from GitHub Actions tab

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Set up Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3️⃣ Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4️⃣ Build and push Docker image
    - name: Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: rahul3043/python-app:latest

    # 5️⃣ Deploy to EC2 via SSH
    - name: Deploy Docker container on EC2
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: 3.108.215.206               # ✅ your EC2 public IP
        username: ubuntu
        key: ${{ secrets.EC2_PEM_KEY }}   # ✅ PEM file added in GitHub Secrets
        script: |
          sudo apt update -y
          sudo apt install docker.io -y
          sudo systemctl start docker
          sudo systemctl enable docker

          sudo docker stop python-app || true
          sudo docker rm python-app || true

          sudo docker pull rahul3043/python-app:latest
          sudo docker run -d -p 5000:5000 --name python-app rahul3043/python-app:latest
